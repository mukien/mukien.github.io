<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>高清MIDI图片镜像翻转视频生成器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0c2461 0%, #1e3799 50%, #4a69bd 100%);
            color: #f0f0f0;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }
        
        .container {
            width: 100%;
            max-width: 1000px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
        }
        
        header {
            text-align: center;
            margin-bottom: 10px;
            width: 100%;
        }
        
        h1 {
            font-size: 2.4rem;
            background: linear-gradient(90deg, #ff9a9e, #fad0c4);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .subtitle {
            font-size: 1.1rem;
            color: #d1d8e0;
            margin-bottom: 20px;
        }
        
        .card {
            background: rgba(25, 42, 86, 0.9);
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .card-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 25px;
            font-size: 1.5rem;
            color: #4bcffa;
        }
        
        .card-title i {
            font-size: 1.7rem;
        }
        
        .upload-area {
            border: 3px dashed #546de5;
            border-radius: 15px;
            padding: 50px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 25px;
            background: rgba(86, 109, 229, 0.1);
            position: relative;
        }
        
        .upload-area:hover, .upload-area.highlight {
            border-color: #4bcffa;
            background: rgba(86, 109, 229, 0.25);
            transform: translateY(-2px);
        }
        
        .upload-icon {
            font-size: 4rem;
            color: #4bcffa;
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-size: 1.3rem;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .upload-subtext {
            color: #a4b0be;
            font-size: 1rem;
        }
        
        .upload-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .file-info {
            background: rgba(86, 109, 229, 0.2);
            border-radius: 12px;
            padding: 18px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid rgba(86, 109, 229, 0.3);
        }
        
        .file-info.hidden {
            display: none;
        }
        
        .file-name {
            font-weight: 600;
            color: #fad390;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 70%;
            font-size: 1.1rem;
        }
        
        .file-size {
            color: #a4b0be;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .remove-btn {
            background: #ff6b81;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .remove-btn:hover {
            background: #ff4757;
            transform: scale(1.1);
        }
        
        .settings-panel {
            background: rgba(86, 109, 229, 0.15);
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-top: 15px;
        }
        
        .setting-group {
            display: flex;
            flex-direction: column;
        }
        
        .setting-group label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: #4bcffa;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .setting-group label i {
            font-size: 1.2rem;
        }
        
        .quality-presets {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .quality-btn {
            padding: 10px 20px;
            background: rgba(86, 109, 229, 0.3);
            border: 1px solid #546de5;
            border-radius: 8px;
            color: #d1d8e0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .quality-btn:hover {
            background: rgba(86, 109, 229, 0.5);
        }
        
        .quality-btn.active {
            background: #546de5;
            color: white;
            box-shadow: 0 0 15px rgba(86, 109, 229, 0.5);
        }
        
        select, input {
            width: 100%;
            padding: 16px;
            background: rgba(30, 39, 70, 0.8);
            border: 2px solid #546de5;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            outline: none;
            transition: all 0.3s ease;
        }
        
        select:focus, input:focus {
            border-color: #4bcffa;
            box-shadow: 0 0 0 3px rgba(75, 207, 250, 0.2);
        }
        
        select:disabled, input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #a4b0be;
        }
        
        .preview-section {
            margin-top: 30px;
        }
        
        .preview-container {
            position: relative;
            width: 100%;
            height: 400px;
            overflow: hidden;
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
            border: 2px solid rgba(86, 109, 229, 0.3);
        }
        
        #preview-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center center;
        }
        
        .preview-canvas {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .resolution-badge {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            color: #4bcffa;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            display: none;
            z-index: 10;
            border: 1px solid rgba(75, 207, 250, 0.3);
        }
        
        .flip-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.8);
            color: #ff9ff3;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: 700;
            display: none;
            z-index: 10;
            border: 2px solid rgba(255, 159, 243, 0.3);
            font-size: 1.1rem;
            animation: flipIndicator 1s ease;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 30px;
            justify-content: center;
        }
        
        button {
            flex: 1;
            min-width: 180px;
            padding: 20px;
            border: none;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            letter-spacing: 0.5px;
        }
        
        .preview-btn {
            background: linear-gradient(135deg, #00d2ff, #3a7bd5);
            color: white;
            box-shadow: 0 5px 15px rgba(0, 210, 255, 0.3);
        }
        
        .preview-btn:hover:not(:disabled) {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 25px rgba(0, 210, 255, 0.5);
        }
        
        .generate-btn {
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            color: #2f3542;
            box-shadow: 0 5px 15px rgba(255, 154, 158, 0.3);
        }
        
        .generate-btn:hover:not(:disabled) {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 25px rgba(255, 154, 158, 0.5);
        }
        
        .stop-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .stop-btn:hover:not(:disabled) {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.5);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .status-panel {
            margin-top: 30px;
            padding: 25px;
            border-radius: 15px;
            background: rgba(86, 109, 229, 0.15);
            text-align: center;
            font-size: 1.1rem;
            width: 100%;
            border: 1px solid rgba(86, 109, 229, 0.3);
        }
        
        .progress-container {
            width: 100%;
            margin-top: 25px;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 25px;
            background: rgba(30, 39, 70, 0.8);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 12px;
            border: 2px solid #546de5;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d2ff, #4bcffa);
            width: 0%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.3), 
                transparent);
            animation: shimmer 2s infinite;
        }
        
        .progress-text {
            text-align: center;
            color: #4bcffa;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .video-output {
            margin-top: 30px;
            display: none;
            width: 100%;
            animation: fadeIn 0.5s ease;
        }
        
        .video-container {
            width: 100%;
            border-radius: 15px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            border: 2px solid rgba(86, 109, 229, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }
        
        #output-video {
            width: 100%;
            display: block;
            border-radius: 13px;
        }
        
        .download-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            width: 100%;
            padding: 22px;
            font-size: 1.3rem;
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.3);
        }
        
        .download-btn:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 25px rgba(155, 89, 182, 0.5);
        }
        
        .instructions {
            margin-top: 35px;
            padding: 25px;
            background: rgba(86, 109, 229, 0.15);
            border-radius: 15px;
            border-left: 5px solid #4bcffa;
        }
        
        .instructions h3 {
            margin-bottom: 15px;
            color: #4bcffa;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .instructions ol {
            padding-left: 25px;
        }
        
        .instructions li {
            margin-bottom: 12px;
            line-height: 1.6;
            font-size: 1.05rem;
        }
        
        .instructions strong {
            color: #ff9ff3;
        }
        
        footer {
            margin-top: 40px;
            text-align: center;
            color: #a4b0be;
            font-size: 0.95rem;
            width: 100%;
            padding-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 25px;
            }
            
            .preview-container {
                height: 350px;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            button {
                min-width: 100%;
                padding: 18px;
            }
        }
        
        @media (max-width: 480px) {
            .preview-container {
                height: 300px;
            }
            
            .upload-area {
                padding: 40px 15px;
            }
            
            .upload-icon {
                font-size: 3.5rem;
            }
        }
        
        @keyframes flipIndicator {
            0% { opacity: 0; transform: translateY(-20px) scale(0.8); }
            20% { opacity: 1; transform: translateY(0) scale(1.1); }
            80% { opacity: 1; transform: translateY(0) scale(1.1); }
            100% { opacity: 0; transform: translateY(-20px) scale(0.8); }
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-hd"></i> 高清MIDI图片镜像翻转视频生成器</h1>
            <p class="subtitle">生成1080P/4K高清视频，每个音符触发一次镜像翻转</p>
        </header>
        
        <main class="card">
            <div class="card-title">
                <i class="fas fa-file-upload"></i>
                <span>上传文件</span>
            </div>
            
            <div class="upload-area" id="midi-upload">
                <div class="upload-icon">
                    <i class="fas fa-file-audio"></i>
                </div>
                <div class="upload-text">点击或拖放MIDI文件</div>
                <div class="upload-subtext">支持标准MIDI格式 (.mid, .midi)</div>
                <input type="file" id="midi-file" accept=".mid,.midi" class="upload-input">
            </div>
            
            <div class="file-info hidden" id="midi-info">
                <div>
                    <div class="file-name" id="midi-name">未选择文件</div>
                    <div class="file-size" id="midi-size"></div>
                </div>
                <button class="remove-btn" id="remove-midi">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="upload-area" id="image-upload">
                <div class="upload-icon">
                    <i class="fas fa-file-image"></i>
                </div>
                <div class="upload-text">点击或拖放高清图片</div>
                <div class="upload-subtext">支持PNG、JPEG、WebP等格式，推荐使用高分辨率图片</div>
                <input type="file" id="image-file" accept="image/*" class="upload-input">
            </div>
            
            <div class="file-info hidden" id="image-info">
                <div>
                    <div class="file-name" id="image-name">未选择文件</div>
                    <div class="file-size" id="image-size"></div>
                </div>
                <button class="remove-btn" id="remove-image">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="settings-panel">
                <div class="card-title">
                    <i class="fas fa-sliders-h"></i>
                    <span>视频设置</span>
                </div>
                
                <div class="settings-grid">
                    <div class="setting-group">
                        <label for="track-select"><i class="fas fa-music"></i> 选择音轨</label>
                        <select id="track-select" disabled>
                            <option value="">请先上传MIDI文件</option>
                        </select>
                    </div>
                    
                    <div class="setting-group">
                        <label for="resolution"><i class="fas fa-expand"></i> 视频分辨率</label>
                        <select id="resolution">
                            <option value="720p">720P (1280×720)</option>
                            <option value="1080p" selected>1080P (1920×1080) - 推荐</option>
                            <option value="2k">2K (2560×1440)</option>
                            <option value="4k">4K (3840×2160) - 高质量</option>
                        </select>
                    </div>
                    
                    <div class="setting-group">
                        <label for="fps"><i class="fas fa-film"></i> 视频帧率 (FPS)</label>
                        <input type="number" id="fps" min="24" max="60" value="30">
                    </div>
                    
                    <div class="setting-group">
                        <label for="duration"><i class="fas fa-clock"></i> 视频时长 (秒)</label>
                        <input type="number" id="duration" min="5" max="60" value="15">
                    </div>
                </div>
                
                <div class="quality-presets">
                    <div class="quality-btn active" data-quality="balanced">
                        <i class="fas fa-balance-scale"></i> 平衡质量
                    </div>
                    <div class="quality-btn" data-quality="high">
                        <i class="fas fa-star"></i> 高质量
                    </div>
                    <div class="quality-btn" data-quality="ultra">
                        <i class="fas fa-gem"></i> 超高质量
                    </div>
                </div>
            </div>
            
            <div class="preview-section">
                <div class="card-title">
                    <i class="fas fa-image"></i>
                    <span>高清预览</span>
                </div>
                
                <div class="preview-container">
                    <div class="resolution-badge" id="resolution-badge">1080P</div>
                    <div class="flip-indicator" id="flip-indicator">镜像翻转!</div>
                    <canvas class="preview-canvas" id="preview-canvas"></canvas>
                    <img id="preview-image" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIwIiBoZWlnaHQ9IjMyMCIgdmlld0JveD0iMCAwIDMyMCAzMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjMyMCIgaGVpZ2h0PSIzMjAiIGZpbGw9InJnYmEoMjAsIDI1LCA4MCwgMC4xNSkiLz48cGF0aCBkPSJNMTYwIDgwTDIyMCAxNjBMMTYwIDI0MEwxMDAgMTYwTDE2MCA4MFoiIGZpbGw9InJnYmEoODYsIDEwOSwgMjI5LCAwLjIpIiBzdHJva2U9IiM1NDZkZTUiIHN0cm9rZS13aWR0aD0iMiIvPjx0ZXh0IHg9IjUwJSIgeT0iNDUlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJyZ2JhKDI1NSwgMjU1LCAyNTUsIDAuOCkiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyNHB4IiBmb250LXdlaWdodD0iNjAwIj5VcGxvYWQgSGlnaC1SZXMgSW1hZ2U8L3RleHQ+PHRleHQgeD0iNTAlIiB5PSI1NSUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9InJnYmEoMjU1LCAyNTUsIDI1NSwgMC42KSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE2cHgiPmZvciBiZXN0IHZpZGVvIHF1YWxpdHk8L3RleHQ+PC9zdmc+" alt="高清图片预览">
                </div>
            </div>
            
            <div class="controls">
                <button id="preview-btn" class="preview-btn" disabled>
                    <i class="fas fa-play-circle"></i>
                    <span>预览效果</span>
                </button>
                <button id="generate-btn" class="generate-btn" disabled>
                    <i class="fas fa-video"></i>
                    <span>生成高清视频</span>
                </button>
                <button id="stop-btn" class="stop-btn" disabled>
                    <i class="fas fa-stop-circle"></i>
                    <span>停止</span>
                </button>
            </div>
            
            <div class="progress-container" id="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">初始化视频编码器...</div>
            </div>
            
            <div class="status-panel" id="status">
                请上传MIDI文件和高清图片以开始生成高质量视频
            </div>
            
            <div class="video-output" id="video-output">
                <div class="card-title">
                    <i class="fas fa-film"></i>
                    <span>生成的高清视频</span>
                </div>
                <div class="video-container">
                    <video id="output-video" controls playsinline></video>
                </div>
                <button id="download-btn" class="download-btn">
                    <i class="fas fa-download"></i>
                    <span>下载高清视频 (MP4)</span>
                </button>
            </div>
        </main>
        
        <div class="instructions">
            <h3><i class="fas fa-info-circle"></i> 使用说明</h3>
            <ol>
                <li><strong>上传高分辨率图片</strong>：建议使用1920×1080或更高分辨率的图片，以获得最佳视频质量</li>
                <li><strong>选择合适的音轨</strong>：MIDI文件中通常包含多个音轨，选择音符较多的音轨效果更好</li>
                <li><strong>设置视频参数</strong>：选择分辨率、帧率和时长</li>
                <li><strong>预览效果</strong>：点击预览按钮查看图片如何根据MIDI音符进行翻转</li>
                <li><strong>生成视频</strong>：点击生成按钮创建高清视频</li>
                <li><strong>下载视频</strong>：生成完成后可以下载MP4格式的高清视频文件</li>
            </ol>
        </div>
        
        <footer>
            <p>© 2023 高清MIDI图片镜像翻转视频生成器 | 使用Canvas和MediaRecorder API实现</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.28/build/Midi.min.js"></script>
    <script>
        // 全局变量
        let midiData = null;
        let selectedTrack = null;
        let isPreviewing = false;
        let isGenerating = false;
        let flipCount = 0;
        let imageElement = document.getElementById('preview-image');
        let canvas = document.getElementById('preview-canvas');
        let ctx = canvas.getContext('2d', { alpha: false });
        let flipIndicator = document.getElementById('flip-indicator');
        let resolutionBadge = document.getElementById('resolution-badge');
        let statusElement = document.getElementById('status');
        
        // 分辨率映射
        const RESOLUTIONS = {
            '720p': { width: 1280, height: 720 },
            '1080p': { width: 1920, height: 1080 },
            '2k': { width: 2560, height: 1440 },
            '4k': { width: 3840, height: 2160 }
        };
        
        // DOM元素
        const midiUploadArea = document.getElementById('midi-upload');
        const midiFileInput = document.getElementById('midi-file');
        const midiInfo = document.getElementById('midi-info');
        const midiName = document.getElementById('midi-name');
        const midiSize = document.getElementById('midi-size');
        const removeMidiBtn = document.getElementById('remove-midi');
        
        const imageUploadArea = document.getElementById('image-upload');
        const imageFileInput = document.getElementById('image-file');
        const imageInfo = document.getElementById('image-info');
        const imageName = document.getElementById('image-name');
        const imageSize = document.getElementById('image-size');
        const removeImageBtn = document.getElementById('remove-image');
        
        const trackSelect = document.getElementById('track-select');
        const resolutionSelect = document.getElementById('resolution');
        const fpsInput = document.getElementById('fps');
        const durationInput = document.getElementById('duration');
        const previewBtn = document.getElementById('preview-btn');
        const generateBtn = document.getElementById('generate-btn');
        const stopBtn = document.getElementById('stop-btn');
        const progressContainer = document.getElementById('progress-container');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const videoOutput = document.getElementById('video-output');
        const outputVideo = document.getElementById('output-video');
        const downloadBtn = document.getElementById('download-btn');
        const qualityBtns = document.querySelectorAll('.quality-btn');
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，初始化应用...');
            
            // 设置Canvas初始分辨率
            updateCanvasResolution();
            
            // 设置事件监听器
            setupEventListeners();
            
            // 更新按钮状态
            updateButtonStates();
            
            // 更新分辨率标签
            updateResolutionBadge();
            
            console.log('应用初始化完成');
        });
        
        // 设置事件监听器
        function setupEventListeners() {
            console.log('设置事件监听器...');
            
            // 文件输入直接点击
            midiFileInput.addEventListener('change', handleMidiFileSelect);
            imageFileInput.addEventListener('change', handleImageFileSelect);
            
            // 上传区域点击事件 - 直接触发文件输入
            midiUploadArea.addEventListener('click', function() {
                console.log('点击MIDI上传区域');
                midiFileInput.click();
            });
            
            imageUploadArea.addEventListener('click', function() {
                console.log('点击图片上传区域');
                imageFileInput.click();
            });
            
            // 移除按钮事件
            removeMidiBtn.addEventListener('click', removeMidiFile);
            removeImageBtn.addEventListener('click', removeImageFile);
            
            // 音轨选择事件
            trackSelect.addEventListener('change', function() {
                selectedTrack = parseInt(this.value);
                updateButtonStates();
                
                if (!isNaN(selectedTrack)) {
                    const track = midiData.tracks[selectedTrack];
                    const trackName = track.name || `音轨 ${selectedTrack + 1}`;
                    statusElement.textContent = `已选择: ${trackName}，包含 ${track.notes.length} 个音符`;
                }
            });
            
            // 分辨率选择事件
            resolutionSelect.addEventListener('change', updateCanvasResolution);
            
            // 质量预设按钮事件
            qualityBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    qualityBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // 控制按钮事件
            previewBtn.addEventListener('click', startPreview);
            generateBtn.addEventListener('click', generateVideo);
            stopBtn.addEventListener('click', stopAll);
            
            // 拖放事件
            setupDragAndDrop();
            
            console.log('事件监听器设置完成');
        }
        
        // 设置拖放功能
        function setupDragAndDrop() {
            // MIDI文件拖放
            midiUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.add('highlight');
            });
            
            midiUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('highlight');
            });
            
            midiUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('highlight');
                
                if (e.dataTransfer.files.length) {
                    handleMidiFile(e.dataTransfer.files[0]);
                }
            });
            
            // 图片文件拖放
            imageUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.add('highlight');
            });
            
            imageUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('highlight');
            });
            
            imageUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('highlight');
                
                if (e.dataTransfer.files.length) {
                    handleImageFile(e.dataTransfer.files[0]);
                }
            });
        }
        
        // 处理MIDI文件选择
        async function handleMidiFileSelect(e) {
            console.log('MIDI文件选择事件触发');
            if (e.target.files.length) {
                await handleMidiFile(e.target.files[0]);
            }
        }
        
        // 处理图片文件选择
        async function handleImageFileSelect(e) {
            console.log('图片文件选择事件触发');
            if (e.target.files.length) {
                await handleImageFile(e.target.files[0]);
            }
        }
        
        // 处理MIDI文件
        async function handleMidiFile(file) {
            console.log('处理MIDI文件:', file.name);
            
            if (!file.name.toLowerCase().match(/\.(mid|midi)$/)) {
                alert('请选择MIDI文件 (.mid 或 .midi)');
                return;
            }
            
            try {
                statusElement.textContent = '正在加载MIDI文件...';
                
                const arrayBuffer = await file.arrayBuffer();
                midiData = new Midi(arrayBuffer);
                
                // 显示文件信息
                midiName.textContent = file.name;
                midiSize.textContent = formatFileSize(file.size);
                midiInfo.classList.remove('hidden');
                
                // 填充音轨选择器
                populateTrackSelector();
                
                statusElement.textContent = `MIDI文件加载成功！包含 ${midiData.tracks.length} 个音轨`;
                updateButtonStates();
                
                console.log('MIDI文件处理完成');
            } catch (error) {
                console.error('MIDI文件加载失败:', error);
                statusElement.textContent = 'MIDI文件加载失败，请确保是有效的MIDI文件';
            }
        }
        
        // 处理图片文件
        async function handleImageFile(file) {
            console.log('处理图片文件:', file.name);
            
            if (!file.type.match('image.*')) {
                alert('请选择图片文件');
                return;
            }
            
            try {
                // 创建临时URL预览图片
                const imageUrl = URL.createObjectURL(file);
                const img = new Image();
                
                img.onload = () => {
                    URL.revokeObjectURL(imageUrl);
                    
                    // 显示文件信息
                    imageName.textContent = file.name;
                    imageSize.textContent = `${formatFileSize(file.size)} | ${img.width}×${img.height}像素`;
                    imageInfo.classList.remove('hidden');
                    
                    // 设置图片源
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imageElement.src = e.target.result;
                        
                        // 图片加载后更新Canvas
                        imageElement.onload = () => {
                            updateCanvasResolution();
                            drawImageToCanvas(false);
                        };
                    };
                    reader.readAsDataURL(file);
                    
                    updateButtonStates();
                    statusElement.textContent = `图片加载成功！分辨率: ${img.width}×${img.height}`;
                };
                
                img.onerror = () => {
                    URL.revokeObjectURL(imageUrl);
                    alert('图片加载失败，请选择有效的图片文件');
                };
                
                img.src = imageUrl;
                
                console.log('图片文件处理完成');
            } catch (error) {
                console.error('图片文件处理失败:', error);
                statusElement.textContent = '图片文件处理失败: ' + error.message;
            }
        }
        
        // 填充音轨选择器
        function populateTrackSelector() {
            console.log('填充音轨选择器');
            trackSelect.innerHTML = '';
            trackSelect.disabled = false;
            
            // 添加默认选项
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '请选择用于触发镜像的音轨';
            trackSelect.appendChild(defaultOption);
            
            // 添加每个音轨的选项
            midiData.tracks.forEach((track, index) => {
                const option = document.createElement('option');
                option.value = index;
                
                const trackName = track.name || `音轨 ${index + 1}`;
                const noteCount = track.notes.length;
                const trackDuration = track.duration ? Math.round(track.duration) : '未知';
                
                option.textContent = `${trackName} - ${noteCount}音符 - ${trackDuration}秒`;
                trackSelect.appendChild(option);
            });
            
            console.log('音轨选择器填充完成');
        }
        
        // 移除MIDI文件
        function removeMidiFile() {
            console.log('移除MIDI文件');
            midiData = null;
            midiInfo.classList.add('hidden');
            trackSelect.innerHTML = '<option value="">请先上传MIDI文件</option>';
            trackSelect.disabled = true;
            selectedTrack = null;
            
            if (isPreviewing || isGenerating) {
                stopAll();
            }
            
            updateButtonStates();
            statusElement.textContent = 'MIDI文件已移除';
        }
        
        // 移除图片文件
        function removeImageFile() {
            console.log('移除图片文件');
            imageElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIwIiBoZWlnaHQ9IjMyMCIgdmlld0JveD0iMCAwIDMyMCAzMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjMyMCIgaGVpZ2h0PSIzMjAiIGZpbGw9InJnYmEoMjAsIDI1LCA4MCwgMC4xNSkiLz48cGF0aCBkPSJNMTYwIDgwTDIyMCAxNjBMMTYwIDI0MEwxMDAgMTYwTDE2MCA4MFoiIGZpbGw9InJnYmEoODYsIDEwOSwgMjI5LCAwLjIpIiBzdHJva2U9IiM1NDZkZTUiIHN0cm9rZS13aWR0aD0iMiIvPjx0ZXh0IHg9IjUwJSIgeT0iNDUlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJyZ2JhKDI1NSwgMjU1LCAyNTUsIDAuOCkiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyNHB4IiBmb250LXdlaWdodD0iNjAwIj5VcGxvYWQgSGlnaC1SZXMgSW1hZ2U8L3RleHQ+PHRleHQgeD0iNTAlIiB5PSI1NSUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9InJnYmEoMjU1LCAyNTMsIDI1NSwgMC42KSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE2cHgiPmZvciBiZXN0IHZpZGVvIHF1YWxpdHk8L3RleHQ+PC9zdmc+';
            imageInfo.classList.add('hidden');
            
            if (isPreviewing || isGenerating) {
                stopAll();
            }
            
            updateButtonStates();
            statusElement.textContent = '图片已移除';
        }
        
        // 更新Canvas分辨率
        function updateCanvasResolution() {
            const resolution = resolutionSelect.value;
            const res = RESOLUTIONS[resolution];
            
            // 设置Canvas尺寸为实际分辨率
            canvas.width = res.width;
            canvas.height = res.height;
            
            // 更新分辨率标签
            resolutionBadge.textContent = resolution.toUpperCase();
            resolutionBadge.style.display = 'block';
            
            // 如果图片已加载，重新绘制
            if (imageElement.complete && imageElement.naturalWidth > 0) {
                drawImageToCanvas(false);
            }
        }
        
        // 更新分辨率标签
        function updateResolutionBadge() {
            resolutionBadge.textContent = resolutionSelect.value.toUpperCase();
            resolutionBadge.style.display = 'block';
        }
        
        // 绘制图片到Canvas
        function drawImageToCanvas(flipped) {
            if (!ctx || !imageElement.complete) return;
            
            // 清除Canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 设置高质量渲染
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            
            // 计算图片位置和尺寸
            const imgWidth = imageElement.naturalWidth;
            const imgHeight = imageElement.naturalHeight;
            
            // 计算最佳缩放比例
            const scale = Math.min(canvas.width / imgWidth, canvas.height / imgHeight);
            const width = imgWidth * scale;
            const height = imgHeight * scale;
            const x = (canvas.width - width) / 2;
            const y = (canvas.height - height) / 2;
            
            ctx.save();
            
            if (flipped) {
                // 水平镜像翻转
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(imageElement, canvas.width - x - width, y, width, height);
            } else {
                ctx.drawImage(imageElement, x, y, width, height);
            }
            
            ctx.restore();
        }
        
        // 开始预览
        function startPreview() {
            if (isPreviewing || !midiData || isNaN(selectedTrack)) return;
            
            console.log('开始预览');
            isPreviewing = true;
            flipCount = 0;
            updateButtonStates();
            
            // 显示Canvas，隐藏图片
            canvas.style.display = 'block';
            imageElement.style.display = 'none';
            
            // 获取选定的音轨
            const track = midiData.tracks[selectedTrack];
            
            if (track.notes.length === 0) {
                statusElement.textContent = '选定的音轨没有音符';
                isPreviewing = false;
                updateButtonStates();
                return;
            }
            
            // 初始绘制
            drawImageToCanvas(false);
            
            // 模拟播放
            simulatePreview(track);
            
            const trackName = track.name || '未命名';
            statusElement.innerHTML = `预览中 - 音轨: <span style="color:#4bcffa">${trackName}</span>，共 ${track.notes.length} 个音符`;
        }
        
        // 模拟预览
        function simulatePreview(track) {
            const fps = 30;
            const duration = Math.min(10, track.duration || 10);
            const totalPreviewFrames = duration * fps;
            let currentFrame = 0;
            
            // 获取音符时间点
            const noteTimes = track.notes.map(note => note.time);
            const maxNoteTime = Math.max(...noteTimes);
            const timeScale = duration / maxNoteTime;
            const scaledNoteTimes = noteTimes.map(time => time * timeScale);
            
            let flipped = false;
            
            function animate() {
                if (!isPreviewing || currentFrame >= totalPreviewFrames) {
                    stopPreview();
                    return;
                }
                
                const currentTime = currentFrame / fps;
                
                // 检查是否有音符在这个时间点
                const noteIndex = scaledNoteTimes.findIndex(time => 
                    Math.abs(time - currentTime) < (0.5 / fps)
                );
                
                if (noteIndex !== -1 && noteIndex % 2 === 0) {
                    // 每两个音符翻转一次
                    flipped = !flipped;
                    flipCount++;
                    
                    // 显示翻转指示器
                    showFlipIndicator();
                    
                    // 绘制翻转后的图片
                    drawImageToCanvas(flipped);
                    
                    // 更新状态
                    const note = track.notes[noteIndex];
                    statusElement.innerHTML = `预览中 - 音符 ${noteIndex+1}/${track.notes.length}: <span style="color:#ff9ff3">${note.name}</span>`;
                }
                
                currentFrame++;
                setTimeout(animate, 1000 / fps);
            }
            
            animate();
        }
        
        // 显示翻转指示器
        function showFlipIndicator() {
            flipIndicator.style.display = 'block';
            flipIndicator.style.animation = 'none';
            void flipIndicator.offsetWidth; // 触发重排
            flipIndicator.style.animation = 'flipIndicator 1s ease';
            
            setTimeout(() => {
                flipIndicator.style.display = 'none';
            }, 1000);
        }
        
        // 停止预览
        function stopPreview() {
            isPreviewing = false;
            
            // 恢复图片显示
            canvas.style.display = 'none';
            imageElement.style.display = 'block';
            
            updateButtonStates();
            statusElement.textContent = `预览完成，共 ${flipCount} 次镜像翻转`;
        }
        
        // 生成视频
        async function generateVideo() {
            if (isGenerating || !midiData || isNaN(selectedTrack)) return;
            
            console.log('开始生成视频');
            isGenerating = true;
            updateButtonStates();
            
            // 显示进度条
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = '准备生成高清视频...';
            
            try {
                // 获取设置
                const fps = parseInt(fpsInput.value) || 30;
                const duration = parseInt(durationInput.value) || 15;
                const track = midiData.tracks[selectedTrack];
                const trackName = track.name || `音轨 ${selectedTrack + 1}`;
                
                statusElement.textContent = `开始生成视频 - ${trackName}，${duration}秒，${fps}FPS`;
                
                // 创建离屏Canvas用于视频生成
                const offscreenCanvas = document.createElement('canvas');
                offscreenCanvas.width = canvas.width;
                offscreenCanvas.height = canvas.height;
                const offscreenCtx = offscreenCanvas.getContext('2d', { alpha: false });
                
                // 创建视频流
                const stream = offscreenCanvas.captureStream(fps);
                const chunks = [];
                
                // 创建MediaRecorder
                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp9',
                    videoBitsPerSecond: 8000000 // 8 Mbps
                });
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        chunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    const videoURL = URL.createObjectURL(blob);
                    outputVideo.src = videoURL;
                    
                    // 显示视频输出区域
                    videoOutput.style.display = 'block';
                    
                    // 更新状态
                    statusElement.textContent = `视频生成完成！${flipCount}次镜像翻转`;
                    isGenerating = false;
                    updateButtonStates();
                    progressContainer.style.display = 'none';
                    
                    // 设置下载按钮
                    downloadBtn.onclick = () => {
                        const a = document.createElement('a');
                        a.href = videoURL;
                        a.download = `midi-mirror-video-${Date.now()}.webm`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    };
                };
                
                // 开始录制
                mediaRecorder.start();
                
                // 生成视频帧
                const totalFrames = duration * fps;
                let frameCount = 0;
                flipCount = 0;
                
                // 获取音符时间点
                const noteTimes = track.notes.map(note => note.time);
                const maxNoteTime = Math.max(...noteTimes);
                const timeScale = duration / maxNoteTime;
                const scaledNoteTimes = noteTimes.map(time => time * timeScale);
                
                let flipped = false;
                
                function generateNextFrame() {
                    if (!isGenerating || frameCount >= totalFrames) {
                        mediaRecorder.stop();
                        return;
                    }
                    
                    const currentTime = frameCount / fps;
                    
                    // 检查是否有音符在这个时间点
                    const noteIndex = scaledNoteTimes.findIndex(time => 
                        Math.abs(time - currentTime) < (0.5 / fps)
                    );
                    
                    if (noteIndex !== -1 && noteIndex % 2 === 0) {
                        // 每两个音符翻转一次
                        flipped = !flipped;
                        flipCount++;
                    }
                    
                    // 绘制当前帧到离屏Canvas
                    drawImageToCanvas(flipped, offscreenCtx, offscreenCanvas.width, offscreenCanvas.height);
                    
                    // 更新进度
                    const progress = (frameCount / totalFrames) * 100;
                    progressFill.style.width = `${progress}%`;
                    progressText.textContent = `生成帧: ${frameCount}/${totalFrames} (${flipCount}次翻转)`;
                    
                    frameCount++;
                    
                    // 控制生成速度
                    setTimeout(generateNextFrame, 1000 / fps);
                }
                
                // 开始生成帧
                generateNextFrame();
                
            } catch (error) {
                console.error('视频生成错误:', error);
                statusElement.textContent = `视频生成失败: ${error.message}`;
                isGenerating = false;
                updateButtonStates();
                progressContainer.style.display = 'none';
            }
        }
        
        // 停止所有操作
        function stopAll() {
            console.log('停止所有操作');
            isPreviewing = false;
            isGenerating = false;
            
            // 恢复图片显示
            canvas.style.display = 'none';
            imageElement.style.display = 'block';
            
            // 隐藏进度条
            progressContainer.style.display = 'none';
            
            statusElement.textContent = '已停止所有操作';
            updateButtonStates();
        }
        
        // 更新按钮状态
        function updateButtonStates() {
            const hasMidi = midiData !== null;
            const hasImage = imageElement.src && !imageElement.src.includes('data:image/svg+xml');
            const hasTrack = !isNaN(selectedTrack);
            
            previewBtn.disabled = !(hasMidi && hasImage && hasTrack) || isGenerating;
            generateBtn.disabled = !(hasMidi && hasImage && hasTrack) || isPreviewing;
            stopBtn.disabled = !isPreviewing && !isGenerating;
            
            console.log('按钮状态更新:', {
                hasMidi, hasImage, hasTrack,
                previewDisabled: previewBtn.disabled,
                generateDisabled: generateBtn.disabled
            });
        }
        
        // 辅助函数：格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>